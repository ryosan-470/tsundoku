# Test Flakiness – Methods for identifying and dealing with flaky tests

https://labs.spotify.com/2019/11/18/test-flakiness-methods-for-identifying-and-dealing-with-flaky-tests/


2019年9月12日、私はトロントで開かれた、[Assert(JS)](https://www.assertjs.com/) で Spotify におけるテスト Flakiness と、flakiness に対応するために長年に渡って構築してきたシステムのいくつかについて発表しました。

[Assert(JS)](https://www.assertjs.com/) はウェブシステムにおける完全自動化テストを専門とするカンファレンスで開催されて2年目になります。このカンファレンスは自動化テストの世界で広く知られている、Kent Dodds、Justin Searls、Aaron Abramov、James ShoreとIsaac Schlueterがスピーカーとして開催されているイベントです。


## テスト flakiness とはなにか?

**flakyなテスト**  (訳注: 以降は*不安定なテスト* と訳します) とは、コードの変更がないのにも関わらず定期的に成功したり失敗したりするテストのことを指しています。不安定なテストは間違いなく迷惑であり、エンジニアはCIでビルド全体を再トリガーする必要があり、多くの場合新しいビルドが正常に完了するのを待つことに多くの時間を要するため、非常にコストがかかるものになります。

しかし実際の不安定なテストによる損失は、テストに対する信頼性の欠如にあります。テストに自信がない場合、テストを行わないチームよりも優位な立場にあります。不安定なテストは自信を持って継続的に配信する能力に大きく影響します。

## flakinessの原因

不安定なテストの原因は多く存在しますが、私の講演では以下を強調して話します。

1. **一貫性のないアサーションのタイミング** アプリケーションの状態がテスト実行中に一貫性がない場合、`expect/assert` ステートメントがランダムに失敗するということに気づくでしょう。これに対する修正は、アサーションが一貫した状態になるのを待ってからアサートするようにテストを構築することです。そのテストが一貫した状態になるまで「待機」するステートメントについては話しません。アサートできる既知の良好な状態に達するまで、アプリケーションの状態をポーリングするための述語を用意する必要があります。
2. **テスト順序の依存** グローバル状態はテストが他のテストに依存する主な原因です。テストを単独で実行できずスイート全体が実行されたときのみテストが成功する場合、この問題が発生しています。解決策としては各テストの実行の間に完全に状態をリセットしグローバル状態への依存性をへらすことにあります。
3. **エンドツーエンドテスト** エンドツーエンドテストは本質的に不安定です。 Write fewer of them. Instead of having 500 end to end tests for your organization, have 5.


## Spotifyでの不安定なテストのトラッキング

長年に渡ってSpotifyではエンジニアリング組織全体に渡ってかなり不安定なテストを削減することに貢献したシステムを構築しました。以下にいくつかツールについての説明を共有します。

**Odeneye**
OdeneyeはSpotifyにおけるテストスイートの可視化と不安定なテストとインフラストラクチャの問題の両者を見分けるためのシステムです。下記にあるイメージを見てください。縦にはそれぞれのテストが並び、横にCIにおけるこれらのテストの結果が表示されています。オレンジ色の点は不安定なテストを示しています。障害の実線が表示されている場合、これは通常ネットワーク障害などのインフラストラクチャの問題やその性質を示しています。このようなビューは不安定なテストやインフラストラクチャの問題を特定するために役立つ素晴らしい方法です。

![](https://spotifylabscom.files.wordpress.com/2019/11/image2.png)


**シンプルな表**
Spotifyには、開発者向けツールの大規模なスイートの一部である別のツールがあります。下のかんたんな表を見ると結果は驚くべきものです。このビューによりチームはテストを確認しどのテストが高速および低速で、どのテストが不安定かを確認できます。単純でしょ?

このテーブルを利用可能にし、他に何もしないことにより、2ヶ月でSpotifyのテストの不安定性を6%から4%に減らしました。あなたの組織において不安定な問題を抱えているのであればこのようなシンプルなツールが劇的な変化をもたらします。

![](https://spotifylabscom.files.wordpress.com/2019/11/image4.png)


**Flaky Bot**
したがってどのテストが不安定であるかを知らせるツールがありますが、エンジニアはどのようにテストが不安定な問題を修正したかを知ることはできますか? これがFlakyBotを作成した理由です。これはSpotifyの内部ツールで、エンジニアがコードをマスターにマージする前にテストが不安定かどうかを判断するのに役立ちます。

エンジニアがプルリクエストにおいてどんなときでもFlaky Botを呼び出しテストがすぐに実行されレポートが表示されます。これにより不安定な問題が修正されたといった高いレベルの自信が得られます。

![](https://paper-attachments.dropbox.com/s_C1A6E2CBB596EE74F4BD96E3085CAB531E3C92B95E18F8AA91C53D64E4200276_1574578515159_image.png)


**結論**
テスト不安定性はすべてのエンジニアリング組織で共通の問題ですが、多くの場合無視され単純な迷惑行為として扱われます。私の講演ではどのように不安定性がはるかに大きな問題として現れ、どのようにそれを軽減するかさらに排除するための措置を講じていくかを説明しています。

これは私にとって初めてのSpotifyの外での公の公演でした。私のスライドは以下にあります。


https://drive.google.com/file/d/1D39rLYwfhptjk9ZdTHVmLG7cAf1eMP3Q/view


[https://drive.google.com/file/d/1D39rLYwfhptjk9ZdTHVmLG7cAf1eMP3Q/edit](https://drive.google.com/file/d/1D39rLYwfhptjk9ZdTHVmLG7cAf1eMP3Q/edit)

